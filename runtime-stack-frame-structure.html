<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Cache-Control" content="no-siteapp">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1, minimum-scale=1, maximum-scale=1">
<meta name="renderer" content="webkit">
<meta name="google" value="notranslate">
<meta name="robots" content="index,follow">


<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Feily Zhang">
<meta name="twitter:description" content="昨夜星辰昨夜风，画楼西畔桂堂东">
<meta name="twitter:image:src" content="https://doc.feily.techhttps://cdn.nlark.com/yuque/0/2019/png/257195/1555147780483-avatar/550c911e-e363-49b7-8d65-21edddf99a07.png?x-oss-process=image/resize,m_fill,w_192,h_192/format,png">

<meta property="og:url" content="https://doc.feily.tech">
<meta property="og:title" content="Feily Zhang">
<meta property="og:description" content="昨夜星辰昨夜风，画楼西畔桂堂东">
<meta property="og:site_name" content="Feily Zhang">
<meta property="og:image" content="https://doc.feily.techhttps://cdn.nlark.com/yuque/0/2019/png/257195/1555147780483-avatar/550c911e-e363-49b7-8d65-21edddf99a07.png?x-oss-process=image/resize,m_fill,w_192,h_192/format,png">
<meta property="og:type" content="website">
<meta name="robots" content="noodp">

<meta itemprop="name" content="Feily Zhang">
<meta itemprop="description" content="昨夜星辰昨夜风，画楼西畔桂堂东">
<meta itemprop="image" content="https://doc.feily.techhttps://cdn.nlark.com/yuque/0/2019/png/257195/1555147780483-avatar/550c911e-e363-49b7-8d65-21edddf99a07.png?x-oss-process=image/resize,m_fill,w_192,h_192/format,png">

<link rel="canonical" href="https://doc.feily.tech">

<link rel="shortcut icon" href="/favicon.ico">
<link rel="apple-itouch-icon" href="/favicon.ico">
<link rel="stylesheet" href="/bundle/index.css">
<script type="text/javascript">
    var timeSinceLang = {
        year: '年前',
        month: '个月前',
        day: '天前',
        hour: '小时前',
        minute: '分钟前',
        second: '秒前'
    };
    var root = '';
</script>


        <meta name="keywords" content="Java Core,">
        <meta name="description" content="JVM运行时栈帧结构">
        <meta name="author" content="林奕清">
        <title>JVM运行时栈帧结构</title>
    </head>
    <body>
        <article class="container">
            <header class="header-wrap" style="font-family:NSimSun">
  <a class="index" href="/">
    <img class="logo" src="https://cdn.nlark.com/yuque/0/2019/png/257195/1555147780483-avatar/550c911e-e363-49b7-8d65-21edddf99a07.png?x-oss-process=image/resize,m_fill,w_192,h_192/format,png" />
    Feily Zhang
  </a>
  <ul class="menu">
      <li class="menu-item"><a href="/archive.html">归档</a></li>
      <li class="menu-item"><a href="/tag.html">标签</a></li>
      <li class="menu-item"><a href="/atom.xml">订阅</a></li>
  </ul>
</header>

            <article class="main article">
                <h1 class="title" style="font-family:KaiTi">JVM运行时栈帧结构</h1>
                <section class="info" style="font-family:KaiTi">
                    <span class="avatar" style="background-image: url(https://cdn.nlark.com/yuque/0/2019/png/257195/1555147780483-avatar/550c911e-e363-49b7-8d65-21edddf99a07.png?x-oss-process=image/resize,m_fill,w_192,h_192/format,png);"></span>
                    <a class="name" href="/about.me.html">林奕清</a>
                    
                    <span class="date" data-time="1556075174"><span class="from"></span></span>
                    
                    <span class="tags"><a class="tag" href="/tag/Java%20Core/index.html">Java Core</a></span>
                </section>
                <article class="content" style="font-family:KaiTi"><p>栈帧(Stack Frame)是用于支持虚拟机方法调用和方法执行的数据结构，它是虚拟机运行时数据区中的虚拟机栈的栈元素。栈帧中存储了方法的局部变量表、操作数栈、动态链接和方法返回出口等信息。每一个方法从调用开始到执行完成的过程，就对应着一个栈帧在虚拟机栈里面从入栈到出栈的过程。</p>

<p>每一个栈帧都包括了局部变量表、操作数栈、动态链接、方法返回地址和一些额外的附加信息。在编译程序代码的时候，栈帧中需要多大的局部变量表、多深的操作数栈都已经完全确定了，并且写入了方法表的Code属性中，因此一个栈帧需要分配多少内存，不会受到程序运行期间变量数据的影响(Slot因作用域的变化可以重用)，而仅仅取决于具体的虚拟机实现。</p>

<p>一个线程中方法调用链可能会很长，很多方法都同时处于执行状态。对于执行引擎来讲，活动线程中，只有栈顶的栈帧是有效的，称为<strong>当前栈帧（Current Stack Frame）</strong>，这个栈帧所关联的方法称为当前方法（Current Method）。<strong>执行引擎所运行的所有字节码指令都只针对当前栈帧进行操作。</strong></p>

<h2>一、局部变量表</h2>

<p>局部变量表（Local Variable Table）是一组变量值存储空间，用于存放方法参数和方法内部定义的局部变量。在Java程序被编译为Class文件时就在方法的Code属性的max_locals数据项中确定了该方法所需要分配的最大局部变量表的容量。</p>

<p>局部变量表的容量以变量槽（Variable Slot）为最小单位，虚拟机规范中并没有明确指明一个Slot应占用的内存空间的大小，只是导向性地说明了每个Slot都应该能存放一个boolean、byte、char、short、int、float、reference（对象的引用）或returnAddress（是为字节码指令jsr、jsr_w、ret服务的，指向了一条字节码指令的地址，即javap中方法的Code属性字节码指令开头的数字）类型的数据，即一个Slot应该能存放一个32位以内的数据类型，对于32位之外的数据类型double、long（均为64位）使用连续的两个Slot存储。</p>

<p>虚拟机通过索引定位的方式使用局部变量表，索引值的范围是从0开始到局部变量表最大的Slot数量。如果是32位数据类型的变量，索引n就代表了使用第n个Slot，如果是64位数据类型的变量，则说明要使用局部变量表第n和第n + 1两个Slot。</p>

<p>在方法执行时，虚拟机是使用局部变量表完成参数值到参数变量列表的传递过程的，如果是实例方法，那么局部变量表中第0位索引即第一个Slot中存放的是用于传递方法所属对象实例的引用，这样的话就可以在该方法中通过this关键字来访问这个方法所属对象的实例变量(因为实例变量是属于某个对象的，该类的对象可能有多个，但是方法是类层面的，方法可能涉及对实例变量的操作，所以调用该类的方法必须通过this关键字指明该方法所属对象的引用，这样就可以拿到该对象的实例变量，<strong>具体而言，方法是通过<code>obj.method()</code>的形式调用的，这样就可以在调用过程中直接将对象obj的堆句柄(或地址)通过一个隐含的参数this传递给method方法，这个this可以理解为方法参数列表隐藏的一个值，然后该方法就会将this传递给局部变量表中的第一个Slot(索引为0)。这样的解释也是有依据的，因为即使方法参数列表没有参数，那么该方法(方法表集合中的属性表集合中的Code属性)的数据项<code>args_size</code>仍然为1，代表的就是隐含的this</strong>)，其余参数则按照参数表的顺序来排列，占用从1(索引)开始的局部变量表的Slot，参数表分配完毕后，再根据方法体内部定义的变量 顺序和作用域分配其余的Slot。</p>

<p>局部变量表中的Slot是可以重用的，方法体中定义的变量，其作用域并不一定会覆盖整个方法体，如果当前PC计数器的值已经超出了某个变量的作用域，那么这个变量对应的Slot就可以分配给其它变量使用。这样设计不仅仅是为了节省栈空间，在某些情况下Slot的复用会直接影响系统的垃圾收集行为。</p>
</article>
                <section class="author" style="font-family:NSimSun">
                    <div class="avatar" style="background-image: url(https://cdn.nlark.com/yuque/0/2019/png/257195/1555147780483-avatar/550c911e-e363-49b7-8d65-21edddf99a07.png?x-oss-process=image/resize,m_fill,w_192,h_192/format,png);"></div>
                    <a class="name" href="/about.me.html">林奕清</a>
                    <div class="intro" style="font-family:KaiTi">我是彗星孤掷久，忆曾飞掠土星环</div>
                </section>
                <section class="recommend" style="font-family:KaiTi">
                    
                    
                    <section class="nav next">
                        <div class="head">下篇文章</div>
                        <a class="link" href="/jvm-runtime-data-area.html">JVM运行时数据区域</a>
                    </section>
                    
                </section>
                
            </article>
        </article>
        <footer class="footer" style="font-family:NSimSun">
    <span class="copyright">
        Feily Zhang ©
        <script type="text/javascript">
            document.write(new Date().getFullYear());
        </script>
    </span>
    <span class="publish">Powered by <a href="http://www.chole.io/" target="_blank">Ink</a></span>
</footer>

        <script src="/bundle/index.js"></script>
    </body>
</html>
